import{A as e,m as t,d as o,a as i}from"./private_share.mg5xph6v1a0c9c7e.js";import{a as n,c as s,d as r,m as a,j as d}from"./comm_utils.mg5xph6v4fda8a3d.js";import{b5 as c,U as l,aV as p,aC as u}from"./topic.mg5xph6vf09b6144.js";import{e as w}from"./render_utils.mg5xph6ve4f7af7e.js";import"./advance.mg5xph6v53ea4027.js";let m=[],h=!1;const g=(e="",t="")=>{const o=e=>(null==e?void 0:e.replace(/^https?:\/\/mmbiz\.(qlogo|qpic)\.cn\//,"https://mmbiz.qpic.cn/"))||"",i=e=>{var t;return(null==(t=null==e?void 0:e.match(/^(?:https?:\/\/)?([^\/?]+(?:\/[^\/?]*)*)/))?void 0:t[1])||""},n=e=>(null==e?void 0:e.replace(/\/640$/,"/0").replace(/\/300$/,"/0"))||"";return e=n(i(o(e))),t=n(i(o(t))),e&&t&&e===t},_=e=>{for(let t of m)if(g(t.cdn_url,e))return t},f=()=>h?Promise.resolve(m):new Promise(((e,t)=>{n({url:"/mp/relatedsearchword?action=getimagekeyword&__biz=".concat(window.biz,"&mid=").concat(window.mid,"&idx=").concat(window.idx,"&enterid=").concat(window.enterid,"&request_id=").concat(Date.now(),"&scene=").concat(window.source,"&sessionid=").concat(window.sessionid),type:"GET",dataType:"json",success:o=>{var i;if(0===(null==(i=null==o?void 0:o.base_resp)?void 0:i.ret)){const{hit_expt:t,items:i=[]}=o||{};t&&(m=i),h=!0,e(m);try{!function(){var e;for(let t of m)x(b(null==(e=null==t?void 0:t.keyword_items)?void 0:e[0]))}()}catch(n){console.error("上报失败",n)}}else t(o)},error:t})})),v=()=>new Promise((t=>{e.invoke("handleMPPageAction",{action:"isEnabledForCircleToSearch",entrance:1},(e=>{console.log("[circle search] isEnabledForCircleToSearch res:",e),e&&e.err_msg&&-1!==e.err_msg.indexOf(":ok")?t({enabled:!0,supportExtInfo:!!(null==e?void 0:e.supportExtInfo)}):t({enabled:!1,supportExtInfo:!!(null==e?void 0:e.supportExtInfo)})}))})),y=async({imageUrl:t="",extInfo:o="",bbox:i,searchScene:n,parentSearchId:s,reportInfoFor33399:r,skipImageUploading:a=!1,succCb:d,failCb:l}={})=>{let p="";try{p=await c(t)}catch(w){console.error("[circle search] download err",w)}const u={action:"startCircleToSearch",skipImageUploading:a,bbox:i,extInfo:o,imageUrl:t,imageData:p,searchScene:n,parentSearchId:s,entrance:1,reportInfoFor33399:r};console.log("[circle search] imageSearch request",u),e.invoke("handleMPPageAction",u,(e=>{console.log("[circle search] imageSearch res",e),e&&e.err_msg&&-1!==e.err_msg.indexOf(":ok")?"function"==typeof d&&d():"function"==typeof l&&l()}))};function b(e,t=101,o=!1){var i,n,s;if(!e)return;const r=(null==e?void 0:e.word)||"",a=(null==e?void 0:e.s1s_stat_info)||"";null==e||e.s1s_context_info;const d=Math.round(Date.now()/1e3);return{Query:r,Extinfo:JSON.stringify({filtertype:1*(null!=(s=null!=(n=null==(i=null==window?void 0:window.cgiData)?void 0:i.verify_status)?n:null==window?void 0:window.verify_status)?s:0)==3?2:0}),ActionType:t,s1s_status_info:a,ActionTimestampMs:d,realTime:o,PullType:(null==e?void 0:e.source)||""}}const x=({Query:e,Extinfo:t,ActionType:o,s1s_status_info:i,ActionTimestampMs:n,realTime:r=!1,PullType:a}={})=>{const d={Uin:window.user_uin,SessionId:window.sessionid,Scene:1*window.source||0,EnterId:1*window.enterid||0,Query:e,Extinfo:t,ActionType:o,s1s_status_info:i,ActionTimestampMs:n,PullType:a};s.report(34875,d,{realTime:r})};const S=t.isMpapp&&t.cpVersion("2.25.0",1,!0,"mpapp"),I=t.isIOS&&1==window._copyright_stat&&1==window.is_need_reward;let C=!1;const A=(e,t)=>{n({url:"/mp/rewardappmsgreport",data:{__biz:window.biz||"",mid:window.mid||"",idx:window.idx||"",oper:t||"",cdn_url:e||"",ascene:window.ascene||-1},type:"POST",dataType:"json",async:!0})};class T{constructor(t){this.isHttpsRes=!!t.isHttpsRes,this.forceReview=!!t.forceReview,this.reviewInterceptor=t.reviewInterceptor,this.getExpandAnimPos=t.getExpandAnimPos,this.imgsSrc=[],this.destroyCb=[],this.detaTime=0,((t.imgs||[]).length||t.container)&&this.add(t);const i=e=>{e&&"number"==typeof e.index&&"function"==typeof t.onChange&&t.onChange(e.index)};(S?o:e).on("onImagePreviewChanged",i),this.destroyCb.push((()=>(S?o:e).remove("onImagePreviewChanged",i)))}destroy(){this.destroyCb.forEach((e=>e())),this.destroyCb=[],this.imgsSrc=[]}add(e){const t=e.imgs||[];if(e.container&&Array.prototype.forEach.call(e.container.getElementsByTagName("img")||[],(e=>t.push(e))),t.forEach((e=>{const t=this.getSrc(e);null!==t&&(this.imgsSrc.push(t),this.bindEvent(e,t))})),I){const e=document.getElementById("js_content");let t=0,o=0;const n=e=>{e&&e.target&&e.target.tagName&&"string"==typeof e.target.tagName&&"IMG"===e.target.tagName.toString().toUpperCase()?(this.detaTime=+new Date,t=e.touches[0].pageX,o=e.touches[0].pageY):this.detaTime=0},s=e=>{const i=e.touches[0].pageX,n=e.touches[0].pageY;Math.abs(i-t)>10&&Math.abs(n-o)>10&&(this.detaTime=0)},r=e=>{0!=this.detaTime&&(+new Date-this.detaTime>800&&+new Date-this.detaTime<6e3?A(e.target.src,1):this.detaTime=0)};i.on(e,"touchstart",n),i.on(e,"touchmove",s),i.on(e,"touchend",r),this.destroyCb.push((()=>i.off(e,"touchstart",n))),this.destroyCb.push((()=>i.off(e,"touchmove",s))),this.destroyCb.push((()=>i.off(e,"touchend",r)))}}parseSearchInfo(e,t,o=17){var i,n,s,a,d,c,l;const p=[];try{const r=()=>{if(e.length<=o)return[0,e.length-1];let i,n;const s=o%2==1?(o-1)/2:o/2;return i=Math.max(0,t-s),n=Math.min(e.length-1,t+(o%2==1?s:s-1)),0===i?n=Math.min(e.length-1,o-1):n===e.length-1&&(i=Math.max(0,e.length-o)),[i,n]},[u,w]=r();for(let t=0;t<e.length;t++){if(t<u||t>w){p.push(null);continue}const o=e[t],r=_(o);if(r){const e=(null==(i=null==r?void 0:r.keyword_items)?void 0:i[0])||{},t=(null==r?void 0:r.url_context_info)||"",{word:u,s1s_stat_info:w,s1s_context_info:m,source:h}=e,g=!!u,_=!!m&&!!t;p.push({searchScene:g?4014:4007,parentSearchId:"135::::".concat(encodeURIComponent(JSON.stringify({s1s_status_info:w}))),extInfo:_?JSON.stringify({s1s_context_info:m,url_context_info:t}):"",skipImageUploading:_,recommendQuery:1*(null!=(a=null!=(s=null==window?void 0:window.verify_status)?s:null==(n=null==window?void 0:window.cgiData)?void 0:n.verify_status)?a:0)==3?"":u,reportInfoFor33399:encodeURIComponent(JSON.stringify({item_show_type:(null==window?void 0:window.item_show_type)||0,mp_image_url:o,mp_source_url:window.location.href})),recommendQueryPullType:h,reportSearchStatusInfoFor34875:w,reportExtInfoFor34875:encodeURIComponent(JSON.stringify({filtertype:1*(null!=(l=null!=(c=null==(d=null==window?void 0:window.cgiData)?void 0:d.verify_status)?c:null==window?void 0:window.verify_status)?l:0)==3?2:0}))})}else p.push({reportInfoFor33399:encodeURIComponent(JSON.stringify({item_show_type:(null==window?void 0:window.item_show_type)||0,mp_image_url:o,mp_source_url:window.location.href}))})}}catch(u){r.error("parse search info",u)}return p}reviewImage(i,n,s,a){const d=this.imgsSrc.indexOf(i),c={current:i,urls:this.imgsSrc,currentInfo:{url:i,data:n,pos:s},searchInfos:this.parseSearchInfo(this.imgsSrc,d),forbidForward:window.isPaySubscribe?1:0};console.log("reviewImage",c,c.current,c.urls.indexOf(c.current));const l=()=>{console.log("previewFlag",C),C||(C=!0,console.log(c),t.isWechat||t.isWxWork||S?(S?o:e).invoke("imagePreview",c,(e=>{console.log("imagePreview response",e),window.__addIdKeyReport&&window.__addIdKeyReport("28307","2")})):window.open(i,"_blank","popup"),setTimeout((()=>{C=!1}),500),r.info("[Appmsg] click image, src: ".concat(i)))};"function"==typeof this.reviewInterceptor?this.reviewInterceptor(a,l,c):l()}getSrc(e){if("1"!==e.getAttribute("data-disable-preview")){let t=e.getAttribute("data-src")||e.getAttribute("src");if(l(t)&&(t=p(t)),!t)return;if(t&&t.indexOf("mmbiz_svg")>0){let t=e.getAttribute("style")||"";return t+=";pointer-events:none;",e.setAttribute("style",t),null}if(t&&0!==t.indexOf("data:")){for(;-1!==t.indexOf("?tp=webp");)t=t.replace("?tp=webp","");e.dataset&&e.dataset.s&&t.isCDN()&&(t=t.replace(/\/640$/,"/0"),t=t.replace(/\/640\?/,"/0?"),t=t.replace(/\/300$/,"/0"),t=t.replace(/\/300\?/,"/0?")),t.isCDN()&&(t=a.addWxfrom(t,3)),t=this.isHttpsRes?t.http2https():t.https2http();const o=e.getAttribute("data-type");return o&&(t=a.addParam(t,"wxtype",o,!0)),t}}return null}bindEvent(e,o){if(void 0===o&&(o=this.getSrc(e)),"1"!=e.getAttribute("data-nopreviewclick")){t.isAndroid&&e.setAttribute("data-wxsrc",o);const n=async i=>{var n,s,r,a;const d={target:i.target,currentTarget:i.currentTarget,type:i.type};if(window.__immersiveListMode&&!window.__immersiveArticleExpanded){const e=new Event("clickImageInImmersive");return document.dispatchEvent(e),i.stopPropagation(),void i.preventDefault()}if((null==(s=null==(n=null==d?void 0:d.target)?void 0:n.classList)?void 0:s.contains("img_loadederror"))||(null==(a=null==(r=null==d?void 0:d.target)?void 0:r.classList)?void 0:a.contains("wx_img_placeholder_err")))return i.stopPropagation(),void i.preventDefault();const c="img"===d.target.tagName.toLowerCase()?d.target:e.querySelector("img");if("function"==typeof window.__addIdKeyReport&&window.__addIdKeyReport("110644",2),window.getComputedStyle&&!this.forceReview){let e=c;const t=e.getBoundingClientRect(),n=.15*t.width,s=.15*t.height;let r=!0;for(;e&&"body"!=e.nodeName.toLowerCase();){const o=window.getComputedStyle(e,null),i=parseInt(o.getPropertyValue("opacity")),a=o.getPropertyValue("filter"),d=o.getPropertyValue("visibility"),c=o.mixBlendMode;if(1!=i||"visible"!==d||a.indexOf("opacity")>=0||a.indexOf("blur")>=0||c&&"normal"!==c){r=!1;break}{const i=e.getBoundingClientRect();if(("hidden"==o.overflow||"hidden"==o.overflowX||"hidden"==o.overflowY)&&(i.left-t.left>n||i.right-t.right<-1*n||i.top-t.top>s||i.bottom-t.bottom<-1*s)){r=!1;break}e=e.parentElement}}if(!r){if(console.log("don't try this again"),"function"==typeof window.__addIdKeyReport){window.__addIdKeyReport("110644",3);const e=new Image,t="https://badjs.weixinbridge.com/badjs?id=168&level=4&from=".concat(encodeURIComponent(location.href),"&msg=").concat(encodeURIComponent(o));e.src=t.slice(0,1024)}return i.stopPropagation(),i.preventDefault(),!1}}if(await w(d))return;i.stopPropagation(),i.preventDefault(),"undefined"==typeof getComputedStyle&&(document.body.currentStyle?window.getComputedStyle=e=>e.currentStyle:window.getComputedStyle={});const l=c,p=window.getComputedStyle(l),u=l.getBoundingClientRect(),m=document.createElement("canvas");m.style.width=p.width,m.style.height=p.height,m.width=parseFloat(p.width),m.height=parseFloat(p.height);let h="";m.getContext("2d").drawImage(l,0,0,parseFloat(p.width),parseFloat(p.height));try{h=m.toDataURL()}catch(_){}t.isAndroid&&(h="");let g="function"==typeof this.getExpandAnimPos&&this.getExpandAnimPos(l,p,u);(g&&"object"!=typeof g||!g&&null!=g)&&(g={}),g&&"object"==typeof g&&(!g.x&&(g.x=u.left-parseFloat(p.paddingLeft)-parseFloat(p.borderLeftWidth)),!g.y&&(g.y=u.top-parseFloat(p.paddingTop)-parseFloat(p.borderTopWidth)),!g.width&&(g.width=u.width-parseFloat(p.paddingLeft)-parseFloat(p.paddingRight)-parseFloat(p.borderLeftWidth)-parseFloat(p.borderRightWidth)),!g.height&&(g.height=u.height-parseFloat(p.paddingTop)-parseFloat(p.paddingBottom)-parseFloat(p.borderTopWidth)-parseFloat(p.borderBottomWidth))),this.reviewImage(o,h,g||{},d),I&&0==this.detaTime&&A(o,2)};i.on(e,"click",n),this.destroyCb.push((()=>i.off(e,"click",n)))}e.removeAttribute("data-nopreviewclick")}}const k={tagName:"mp-common-vote",loginCheckFailed:0};function E(e){new T({container:e.shadowRoot.querySelector(".jsVoteList"),isHttpsRes:!0})}function j(e,t,o){const{vote_subject:s,super_vote_id:r}=t,a=e.shadowRoot.querySelectorAll(".js_wx_tap_highlight"),c=e.shadowRoot.querySelectorAll(".js_vote_item"),l=e.shadowRoot.querySelector(".js_tool_area"),p=e.shadowRoot.querySelector(".js_ban_area");let w=!1;a&&a.length&&a.forEach((e=>{i.on(e,"touchstart",(e=>{const t=e.currentTarget;u.highlightEle(t),e.stopPropagation()}))}));const m=t=>{let o=0;0==+window.item_show_type?o=0:8==+window.item_show_type?o=1:10==+window.item_show_type&&(o=2);const i={action:"vote",__biz:window.biz,uin:window.uin,key:window.key,pass_ticket:window.pass_ticket,appmsg_token:window.appmsg_token,f:"json",json:JSON.stringify({super_vote_id:r,super_vote_item:t}),page_type:o},{idx:a,mid:d,wxtoken:c,reprint_ticket:l,source_mid:p,source_idx:u}=window;a&&(i.idx=window.idx),d&&(i.mid=d),c&&(i.wxtoken=c),l&&(i.reprint_ticket=l),p&&(i.source_mid=p),u&&(i.source_idx=u),n({url:"/mp/newappmsgvote",data:i,dataType:"json",type:"post",success(o){o.base_resp&&1*o.base_resp.ret==0?(t.forEach((e=>{const{vote_id:t,item_idx_list:o}=e,i=s.findIndex((e=>e.vote_id===t));o.item_idx.forEach((e=>{s[i].options[e].selected=!0,s[i].options[e].cnt++,s[i].total_cnt++}))})),w=!1,function(e,t){e.setAttribute("data-votesubject",JSON.stringify(t)),setTimeout((()=>{E(e)}))}(e,s)):o.base_resp&&1*o.base_resp.ret==-7?(w=!1,window.weui.toast("关注公众号后才可以投票",{extClass:"weui-toast_text"})):o.base_resp&&1*o.base_resp.ret==-6?(w=!1,window.weui.toast("投票过于频繁，请稍后再试",{extClass:"weui-toast_text"})):o.base_resp&&1*o.base_resp.ret==166001?window.weui.toast("投票已过期",{extClass:"weui-toast_text"}):o.base_resp&&1*o.base_resp.ret==166002?window.weui.toast("投票已删除",{extClass:"weui-toast_text"}):(w=!1,window.weui.toast("投票失败，请稍后再试",{extClass:"weui-toast_text"}))},error(){w=!1,window.weui.toast("投票失败，请稍后再试",{extClass:"weui-toast_text"})}})};l&&i.on(l,"click",".js_submit_btn",(()=>{const t=function(e,t){const o=[];return e&&e.length&&e.forEach(((e,i)=>{const n=e.options||[],s=[];let r=!1;n.forEach(((e,o)=>{const n=t.shadowRoot.querySelector("#vote_".concat(i,"_").concat(o));n&&n.checked&&(r=!0,s.push(o))})),r&&o.push({vote_id:e.vote_id,item_idx_list:{item_idx:s}})})),o}(s,e);return!(w||!t.length)&&(window.is_temp_url?(window.weui.toast("预览状态下无法操作",{extClass:"weui-toast_text"}),!1):(w=!0,window.appmsg_token?d.setSum(68064,11,1):d.setSum(68064,12,1),void m(t)))})),p&&i.on(p,"click",".js_refresh_btn",(()=>{e.setAttribute("data-retry","1"),R(r).then((t=>{N(e,JSON.parse(t))})).catch((()=>{N(e,{super_vote_id:r,expire_time:"",fail:1})}))})),-1!==["8","10"].indexOf("".concat(o))&&1*t.del_flag==0&&[...c].forEach((t=>i.on(t,"click",".js_vote_option",(t=>{const o=function(e,t){const o=[];if(e&&e.length){let{target:i}=t;do{if(-1!==i.className.indexOf("js_vote_option"))break;i=i.parentNode||null}while(i);const n=i.querySelector("label.vote_option_inner"),s=(n&&n.getAttribute("for")||"").match(/vote_(\d+)_(\d+)/);if(s&&s[0]){const t=+s[1],i=+s[2],n=e[t];(n&&n.options||[])[i]&&o.push({vote_id:n.vote_id,item_idx_list:{item_idx:[i]}})}}return o}(s,t);if(w||!o.length)return!1;if(window.is_temp_url)return window.weui.toast("预览状态下无法操作",{extClass:"weui-toast_text"}),!1;const{logincheckfailed:i}=e.dataset||{};return 1*i!=1?(w=!0,m(o),!1):void 0})))),E(e)}function N(e,o){let i=k.loginCheckFailed;t.isWechat||t.isWindowsWechat||t.isMacWechat||(i=1);let n=e;if(1*o.del_flag==0){if(e.tagName.toLowerCase()!==k.tagName){const t=document.createElement(k.tagName),o=document.createElement("section");o.setAttribute("class","mp_vote_iframe_wrp"),o.appendChild(t);const i=e.parentNode.parentNode;i&&(i.appendChild(o),i.removeChild(e.parentNode)),n=t}n.setAttribute("data-supervoteid",o.super_vote_id),n.setAttribute("data-logincheckfailed",i),n.setAttribute("data-expiretime",o.expire_time),n.setAttribute("data-votesubject",o.vote_subject?JSON.stringify(o.vote_subject):"[]"),n.setAttribute("data-itemshowtype",window.item_show_type),n.setAttribute("data-fail",o.fail||"0"),n.setAttribute("data-retry","0"),n.setAttribute("data-delflag",o.del_flag),setTimeout((()=>{j(n,o,window.item_show_type)}),0)}else n.parentNode.removeChild(n)}function R(e){return new Promise(((t,o)=>{n({type:"GET",dataType:"json",url:"/mp/newappmsgvote?action=show&supervoteid=".concat(e,"&__biz=").concat(window.biz,"&mid=").concat(window.mid,"&idx=").concat(window.idx),timeout:1e4,success:e=>{e&&e.base_resp&&1*e.base_resp.ret==0&&e.data?(k.loginCheckFailed=1*e.login_check_failed,t(e.data)):o()},error:e=>o(e)})}))}function P(){!function(){if(!document.getElementById("js_content"))return;const e=document.querySelectorAll("iframe"),t=[];e.forEach((e=>{const o=e.getAttribute("data-src")||"",i=e.className||"";o.indexOf("newappmsgvote")>-1&&(i.indexOf("js_editor_vote_card")>=0||i.indexOf("vote_iframe")>=0)&&t.push(e)})),(Array.from(document.getElementsByTagName(k.tagName))||[]).concat(t).forEach((e=>{const t=e.getAttribute("data-supervoteid")||"";R(t).then((t=>{N(e,JSON.parse(t))})).catch((()=>{N(e,{super_vote_id:t,expire_time:"",fail:1})}))}))}()}export{T as R,P as a,v as b,_ as g,f as i,x as r,y as s};
